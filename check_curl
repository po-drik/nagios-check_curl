#!/usr/bin/php
<?php
/**
 * check_curl.php
 * Original authors:
 *  - Vit Safar (CZ), v1.0, 20.10.2006
 *  - Donald Fellow (US), v1.1, 08.06.2007
 *  - Ryan Snyder (US), v1.2, 14.04.2011
 *  - Miguel Calvo (ES), v1.3, 26.06.2018
 *  - Tatsuya Morikawa (JP), v1.4, 09.06.2020
 *  - Miguel Calvo (ES), v1.5 (22.08.2025)
 *
 * What’s new:
 * - Added: --tlsv1.2 / --tls12, --cacert <file>, --capath <dir>
 * - Fixed: safe strpos() checks (use !== false)
 * - Safer defaults, clearer errors, cleaned cookie handling
 * - Help text in easy British English
 */

// ========================= Default settings =========================
$Debug        = 0;
$Timeout      = 10;
$Agent        = 'Mozilla/5.0 (X11; Linux x86_64; rv:10.0) Gecko/20150101 Firefox/47.0 (Chrome)';
$Status       = 0;
$IncludePerf  = 1;
$httpCode     = 200;
$ShowPage     = 0;
$authOption   = '';
$cookiejar    = '/tmp/.check_curl.cookies.txt';
$UseOutput    = 0;

// Lists filled on demand
$headers      = [];
$Grep         = [];
$NGrep        = [];

// Optional limits / counters
$grepNumber   = null;
$Tc = $Tw = $Sbc = $Sbw = $Soc = $Sow = null;
$tag = null;
$String1 = $String2 = null;

// TLS/CA flags
$sslVerifyDisabled = false;
$wantsCA = false; // true if --cacert/--capath used

// ========================= Helpers =========================
function getmicrotime() {
    list($usec, $sec) = explode(" ", microtime());
    return ((float) $usec + (float) $sec);
}

function Manual() {
    echo "------- check_curl.php written by Vit Safar (CZ), v1.0, 20.10.2006 ---------
------------------- modified by Donald Fellow (US), v1.1, 08.06.2007 ---------
------------------- modified by Ryan Snyder (US), v1.2, 14.04.2011 ---------
------------------- modified by Miguel Calvo (ES), v1.3, 26.06.2018 ---------
------------------- modified by Tatsuya Morikawa (JP), v1.4, 09.06.2020 ---------
------------------- updated & optimised by Miguel Calvo (ES), v1.5, 22.08.2025 ----------------------

Usage (simple and clear):

  php check_curl.php -U \"https://host:8080/user/ptestuser3\" --tlsv1.2 --cacert /etc/path/ca.crt -T 10 -hc 200

Options:
  -Me <METHOD>         Custom request method (HTTP, FTP, IMAP, POP3, SMTP, etc.)
  -U <URL>             Target URL
  -A <UA>              User-Agent (default: Mozilla/5.0 ...)
  -a <user:pass>       Basic authentication (user:pass)
  -ao <CURLAUTH_*>     Auth method: CURLAUTH_DIGEST/NEGOTIATE/NTLM/ANY/ANYSAFE/BASIC
  -he <Header: Val>    Extra HTTP header (repeatable)
  -G <text>            Must appear in the response (repeatable)
  -NG <text>           Must NOT appear in the response (repeatable)
  -Gn <N>              Expected number of occurrences for -G (use exactly one -G pattern)
  -L                   Print the page body
  -F                   Follow redirects
  -I                   Ignore SSL certificate errors (disables verification)  **Do not use with --cacert/--capath**
  -X                   Exclude performance data from output
  -Tc <seconds>        Critical time limit
  -Tw <seconds>        Warning time limit
  -Sbc <bytes>         Critical if size is below this
  -Soc <bytes>         Critical if size is over this
  -Sbw <bytes>         Warning if size is below this
  -Sow <bytes>         Warning if size is over this
  -S <start> <end>     Extract text between two strings (first match)
  -T <seconds>         Timeout (default 10s)
  -O                   Output-driven check (expects page to include \"Status: OK/WARNING/CRITICAL\")
  -hc <HTTP_CODE>      Expected HTTP code (default 200)
  -tag <text>          Tag shown at the start of the message
  -Px <host>           Proxy host
  -PxPort <port>       Proxy port
  -PxAuth <u:p>        Proxy authentication (user:pass)

  --tlsv1.2 | --tls12  Force TLS 1.2
  --cacert <file>      Path to a PEM CA file (to verify server)
  --capath <dir>       Path to a directory of PEM CA files (to verify server)

Notes:
  • If you use --cacert or --capath, SSL verification is enabled (VERIFYHOST=2, VERIFYPEER=1).
  • Do not combine -I (ignore SSL) with --cacert/--capath.
  • The CA file should be PEM. For a self-signed server, use its certificate as the CA.
\n";
}

// ========================= Main =========================
$ch = curl_init();

$Pocet = count($argv);
if ($Pocet <= 1) {
    Manual();
    exit(3);
}

// Base options
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_HEADER, 0);
curl_setopt($ch, CURLOPT_USERAGENT, $Agent);
curl_setopt($ch, CURLOPT_TIMEOUT, $Timeout);
curl_setopt($ch, CURLOPT_COOKIEJAR, $cookiejar);

// Parse CLI
for ($i = 1; $i < $Pocet; $i++) {
    switch ($argv[$i]) {
        case '-Me':
            if ($Pocet > $i + 1) {
                curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $argv[++$i]);
                if ($Debug) echo "\nDEBUG: -Me {$argv[$i]}";
            } else { echo "UNKNOWN - ERROR -Me: missing value\n"; exit(3); }
            break;

        case '-U':
            if ($Pocet > $i + 1) {
                curl_setopt($ch, CURLOPT_URL, $argv[++$i]);
                if ($Debug) echo "\nDEBUG: -U {$argv[$i]}";
            } else { echo "UNKNOWN - ERROR -U: missing value\n"; exit(3); }
            break;

        case '-A':
            if ($Pocet > $i + 1) {
                $Agent = $argv[++$i];
                curl_setopt($ch, CURLOPT_USERAGENT, $Agent);
                if ($Debug) echo "\nDEBUG: -A {$argv[$i]}";
            } else { echo "UNKNOWN - ERROR -A: missing value\n"; exit(3); }
            break;

        case '-a':
            if ($Pocet > $i + 1) {
                curl_setopt($ch, CURLOPT_USERPWD, $argv[++$i]);
                if ($Debug) echo "\nDEBUG: -a {$argv[$i]}";
            } else { echo "UNKNOWN - ERROR -a: missing value\n"; exit(3); }
            break;

        case '-ao':
            if ($Pocet > $i + 1) {
                $authOption = $argv[++$i];
                if ($Debug) echo "\nDEBUG: -ao {$argv[$i]}";
            } else { echo "UNKNOWN - ERROR -ao: missing value\n"; exit(3); }
            break;

        case '-he':
            if ($Pocet > $i + 1) {
                $headers[] = $argv[++$i];
                if ($Debug) echo "\nDEBUG: -he {$argv[$i]}";
            } else { echo "UNKNOWN - ERROR -he: missing value\n"; exit(3); }
            break;

        case '-T':
            if ($Pocet > $i + 1) {
                $Timeout = (int)$argv[++$i];
                curl_setopt($ch, CURLOPT_TIMEOUT, $Timeout);
                if ($Debug) echo "\nDEBUG: -T {$Timeout}";
            } else { echo "UNKNOWN - ERROR -T: missing value\n"; exit(3); }
            break;

        case '-NG':
            if ($Pocet > $i + 1) {
                $NGrep[] = $argv[++$i];
                if ($Debug) echo "\nDEBUG: -NG {$argv[$i]}";
            } else { echo "UNKNOWN - ERROR -NG: missing value\n"; exit(3); }
            break;

        case '-G':
            if ($Pocet > $i + 1) {
                $Grep[] = $argv[++$i];
                if ($Debug) echo "\nDEBUG: -G {$argv[$i]}";
            } else { echo "UNKNOWN - ERROR -G: missing value\n"; exit(3); }
            break;

        case '-Gn':
            if ($Pocet > $i + 1) {
                $grepNumber = (int)$argv[++$i];
                if ($Debug) echo "\nDEBUG: -Gn {$grepNumber}";
            } else { echo "UNKNOWN - ERROR -Gn: missing value\n"; exit(3); }
            break;

        case '-hc':
            if ($Pocet > $i + 1) {
                $httpCode = (int)$argv[++$i];
                if ($Debug) echo "\nDEBUG: -hc {$httpCode}";
            } else { echo "UNKNOWN - ERROR -hc: missing value\n"; exit(3); }
            break;

        case '-Tc':
            if ($Pocet > $i + 1) { $Tc = (float)$argv[++$i]; if ($Debug) echo "\nDEBUG: -Tc {$Tc}"; }
            else { echo "UNKNOWN - ERROR -Tc: missing value\n"; exit(3); }
            break;

        case '-Tw':
            if ($Pocet > $i + 1) { $Tw = (float)$argv[++$i]; if ($Debug) echo "\nDEBUG: -Tw {$Tw}"; }
            else { echo "UNKNOWN - ERROR -Tw: missing value\n"; exit(3); }
            break;

        case '-Sbc':
            if ($Pocet > $i + 1) { $Sbc = (int)$argv[++$i]; if ($Debug) echo "\nDEBUG: -Sbc {$Sbc}"; }
            else { echo "UNKNOWN - ERROR -Sbc: missing value\n"; exit(3); }
            break;

        case '-Sbw':
            if ($Pocet > $i + 1) { $Sbw = (int)$argv[++$i]; if ($Debug) echo "\nDEBUG: -Sbw {$Sbw}"; }
            else { echo "UNKNOWN - ERROR -Sbw: missing value\n"; exit(3); }
            break;

        case '-Soc':
            if ($Pocet > $i + 1) { $Soc = (int)$argv[++$i]; if ($Debug) echo "\nDEBUG: -Soc {$Soc}"; }
            else { echo "UNKNOWN - ERROR -Soc: missing value\n"; exit(3); }
            break;

        case '-Sow':
            if ($Pocet > $i + 1) { $Sow = (int)$argv[++$i]; if ($Debug) echo "\nDEBUG: -Sow {$Sow}"; }
            else { echo "UNKNOWN - ERROR -Sow: missing value\n"; exit(3); }
            break;

        case '-S':
            if ($Pocet > $i + 2) {
                $String1 = $argv[++$i];
                $String2 = $argv[++$i];
                if ($Debug) echo "\nDEBUG: -S {$String1} {$String2}";
            } else { echo "UNKNOWN - ERROR -S: missing values\n"; exit(3); }
            break;

        case '-O':
            $UseOutput = 1;
            if ($Debug) echo "\nDEBUG: -O";
            break;

        case '-L':
            $ShowPage = 1;
            if ($Debug) echo "\nDEBUG: -L";
            break;

        case '-F':
            curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
            if ($Debug) echo "\nDEBUG: -F";
            break;

        case '-X':
            $IncludePerf = 0;
            if ($Debug) echo "\nDEBUG: -X";
            break;

        case '-I':
            // Disables SSL verification. Do not use with --cacert/--capath.
            curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
            curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
            $sslVerifyDisabled = true;
            if ($Debug) echo "\nDEBUG: -I (SSL verification disabled)";
            break;

        case '-tag':
            if ($Pocet > $i + 1) { $tag = $argv[++$i]; if ($Debug) echo "\nDEBUG: -tag {$tag}"; }
            else { echo "UNKNOWN - ERROR -tag: missing value\n"; exit(3); }
            break;

        case '-Px':
            if ($Pocet > $i + 1) { curl_setopt($ch, CURLOPT_PROXY, $argv[++$i]); if ($Debug) echo "\nDEBUG: -Px {$argv[$i]}"; }
            else { echo "UNKNOWN - ERROR -Px: missing value\n"; exit(3); }
            break;

        case '-PxPort':
            if ($Pocet > $i + 1) { curl_setopt($ch, CURLOPT_PROXYPORT, (int)$argv[++$i]); if ($Debug) echo "\nDEBUG: -PxPort {$argv[$i]}"; }
            else { echo "UNKNOWN - ERROR -PxPort: missing value\n"; exit(3); }
            break;

        case '-PxAuth':
            if ($Pocet > $i + 1) { curl_setopt($ch, CURLOPT_PROXYUSERPWD, $argv[++$i]); if ($Debug) echo "\nDEBUG: -PxAuth {$argv[$i]}"; }
            else { echo "UNKNOWN - ERROR -PxAuth: missing value\n"; exit(3); }
            break;

        // ================= TLS/CA NEW =================
        case '--tlsv1.2':
        case '--tls12':
            // Force TLS 1.2 (6 is the legacy numeric for TLSv1.2 on older libcurl)
            $tlsConst = defined('CURL_SSLVERSION_TLSv1_2') ? CURL_SSLVERSION_TLSv1_2 : 6;
            curl_setopt($ch, CURLOPT_SSLVERSION, $tlsConst);
            if ($Debug) echo "\nDEBUG: --tlsv1.2";
            break;

        case '--cacert':
            if ($Pocet > $i + 1) {
                $cafile = $argv[++$i];
                $wantsCA = true;
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);
                curl_setopt($ch, CURLOPT_CAINFO, $cafile);
                if ($Debug) echo "\nDEBUG: --cacert {$cafile}";
            } else { echo "UNKNOWN - ERROR --cacert: missing value\n"; exit(3); }
            break;

        case '--capath':
            if ($Pocet > $i + 1) {
                $capath = $argv[++$i];
                $wantsCA = true;
                curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1);
                curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);
                curl_setopt($ch, CURLOPT_CAPATH, $capath);
                if ($Debug) echo "\nDEBUG: --capath {$capath}";
            } else { echo "UNKNOWN - ERROR --capath: missing value\n"; exit(3); }
            break;

        case '--help':
        case '-h':
            Manual();
            exit(3);

        default:
            echo "UNKNOWN - ERROR in argument parsing: {$argv[$i]}\n";
            exit(3);
    }
}

// Conflict check: do not allow -I with --cacert/--capath
if ($sslVerifyDisabled && $wantsCA) {
    echo "UNKNOWN - Conflicting options: -I (ignore SSL) cannot be used with --cacert/--capath (verify SSL)\n";
    if ($cookiejar && is_file($cookiejar)) @unlink($cookiejar);
    exit(3);
}

// Apply headers if any
if (!empty($headers)) {
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
}

// Auth method
switch ($authOption) {
    case 'CURLAUTH_DIGEST':    curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_DIGEST); break;
    case 'CURLAUTH_NEGOTIATE': curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_NEGOTIATE); break;
    case 'CURLAUTH_NTLM':      curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_NTLM); break;
    case 'CURLAUTH_ANY':       curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_ANY); break;
    case 'CURLAUTH_ANYSAFE':   curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_ANYSAFE); break;
    case 'CURLAUTH_BASIC':
    default:                   curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_BASIC); break;
}

// Limits sanity checks
if (isset($Tc, $Tw) && $Tw >= $Tc) { echo "UNKNOWN - ERROR: Tw ($Tw) >= Tc ($Tc)\n"; exit(3); }
if (isset($Sbc, $Sbw) && $Sbw >= $Sbc) { echo "UNKNOWN - ERROR: Sbw ($Sbw) >= Sbc ($Sbc)\n"; exit(3); }
if (isset($Soc, $Sow) && $Sow >= $Soc) { echo "UNKNOWN - ERROR: Sow ($Sow) >= Soc ($Soc)\n"; exit(3); }

// ========================= Execute =========================
$time_start = getmicrotime();
$Buff       = @curl_exec($ch);
$Time       = round(getmicrotime() - $time_start, 3);
$Size       = is_string($Buff) ? strlen($Buff) : 0;
$errnum     = curl_errno($ch);

if ($errnum) {
    if ($errnum == 28) {
        echo "CRITICAL - Timeout {$Timeout} sec exceeded\n";
        if ($cookiejar && is_file($cookiejar)) @unlink($cookiejar);
        exit(2);
    } else {
        echo "CRITICAL - Error opening page: " . curl_error($ch) . "\n";
        if ($cookiejar && is_file($cookiejar)) @unlink($cookiejar);
        exit(2);
    }
}

$reqInfo = curl_getinfo($ch);
@curl_close($ch);

// ========================= Evaluate =========================
$message = '';

if ((int)$reqInfo['http_code'] !== (int)$httpCode) {
    $Status = 2;
    $message .= ' Call returned unexpected HTTP code ' . $reqInfo['http_code'] . ' |';
}

if (isset($Sbw) && ($Size < $Sbw)) {
    $Status = max($Status, 1);
    $message .= " Page size {$Size}B below warning limit {$Sbw}B |";
} elseif (isset($Sbc) && ($Size < $Sbc)) {
    $Status = 2;
    $message .= " Page size {$Size}B below critical limit {$Sbc}B |";
} elseif (isset($Sbc) || isset($Sbw)) {
    $message .= " Page size {$Size}B is within limits |";
}

if (isset($Sow) && ($Size > $Sow)) {
    $Status = max($Status, 1);
    $message .= " Page size {$Size}B over warning limit {$Sow}B |";
} elseif (isset($Soc) && ($Size > $Soc)) {
    $Status = 2;
    $message .= " Page size {$Size}B over critical limit {$Soc}B |";
} elseif (isset($Soc) || isset($Sow)) {
    $message .= " Page size {$Size}B is within limits |";
}

if (isset($Tw) && ($Time > $Tw)) {
    $Status = max($Status, 1);
    $message .= " Download time {$Time}s exceeded warning limit {$Tw}s |";
} elseif (isset($Tc) && ($Time > $Tc)) {
    $Status = 2;
    $message .= " Download time {$Time}s exceeded critical limit {$Tc}s |";
} elseif (isset($Tc) || isset($Tw)) {
    $message .= " Download time {$Time}s is within limits |";
}

// Positive searches (-G)
if (!empty($Grep)) {
    if ($grepNumber === null) {
        $foundMessage = ' Strings found: ';
        $notFound = false;
        foreach ($Grep as $g) {
            if (strpos($Buff, $g) === false) {
                $Status = 2;
                $notFound = true;
                $message .= " String {$g} not found";
                break;
            } else {
                $foundMessage .= $g . ', ';
            }
        }
        if (!$notFound) $message .= $foundMessage;
    } else {
        if (count($Grep) !== 1) {
            echo "UNKNOWN - ERROR for -Gn: when used, provide exactly one -G pattern\n";
            if ($cookiejar && is_file($cookiejar)) @unlink($cookiejar);
            exit(3);
        }
        $occ = substr_count($Buff, $Grep[0]);
        if ($occ !== $grepNumber) {
            $Status = 2;
            $message .= " Expected {$grepNumber} occurrences of '{$Grep[0]}', found {$occ}";
        } else {
            $message .= " Found {$grepNumber} occurrences of '{$Grep[0]}'";
        }
    }
    $message .= ' |';
}

// Negative searches (-NG)
if (!empty($NGrep)) {
    $foundAny = false;
    $foundMessage = ' Strings not found: ';
    foreach ($NGrep as $ng) {
        if (strpos($Buff, $ng) !== false) {
            $Status = 2;
            $foundAny = true;
            $message .= " String {$ng} was found";
            break;
        } else {
            $foundMessage .= $ng . ', ';
        }
    }
    if (!$foundAny) $message .= $foundMessage;
    $message .= ' |';
}

// -S extract between two strings (first match)
if (isset($String1) || isset($String2)) {
    if (isset($String1, $String2)) {
        $First = strpos($Buff, $String1);
        if ($First !== false) {
            $Last = strpos($Buff, $String2, $First + strlen($String1));
            if ($Last !== false) {
                $between = substr($Buff, $First + strlen($String1), $Last - $First - strlen($String1));
                $message .= " Found '{$between}' between positions {$First} and {$Last} |";
            } else {
                echo "UNKNOWN - ERROR for -S: second string '{$String2}' not found\n";
                if ($cookiejar && is_file($cookiejar)) @unlink($cookiejar);
                exit(3);
            }
        } else {
            echo "UNKNOWN - ERROR for -S: first string '{$String1}' not found\n";
            if ($cookiejar && is_file($cookiejar)) @unlink($cookiejar);
            exit(3);
        }
    } else {
        echo "UNKNOWN - ERROR for -S: please provide two strings (before and after)\n";
        if ($cookiejar && is_file($cookiejar)) @unlink($cookiejar);
        exit(3);
    }
}

// -O Output-driven
if ($UseOutput) {
    $StatusHeader = "Status:";
    $StatusSeperator = "-";
    $First = strpos($Buff, $StatusHeader);
    if ($First !== false) {
        $Last = strpos($Buff, $StatusSeperator, $First + strlen($StatusHeader));
        if ($Last !== false) {
            // Keep legacy behaviour: read status word, then append the rest
            $OutputStatus = trim(substr($Buff, $First + strlen($StatusHeader), $Last - $First - strlen($StatusHeader)));
            $tail = substr($Buff, $First + 8); // assumes "Status: " (7 + space) for compatibility
            $upper = strtoupper($OutputStatus);
            if ($upper === "CRITICAL") { $Status = 2; $message .= $tail; }
            elseif ($upper === "WARNING") { $Status = max($Status, 1); $message .= $tail; }
            else { $message .= $tail; }
        }
    }
}

// Final message
$message = ($tag ? $tag . " - " : "") . $message;

switch ($Status) {
    case 1:  $message = 'WARNING - '  . $message; break;
    case 2:  $message = 'CRITICAL - ' . $message; break;
    case 3:  $message = 'UNKNOWN - '  . $message; break;
    default: $message = 'OK - '       . $message; $Status = 0; break;
}

if ($IncludePerf) $message .= " |time={$Time} size={$Size}\n";

echo $message;

if ($ShowPage && is_string($Buff)) {
    echo "\n\n----------------------------- Page content ----------------------------\n\n" . $Buff . "\n";
}

// Tidy up cookiejar
if ($cookiejar && is_file($cookiejar)) {
    @unlink($cookiejar);
}

exit($Status);
